<!DOCTYPE html>
<html>
    <head>
        <style>
            [data-open]
            {
                position:relative;
                display:block;
                height:0;
                overflow:hidden;
                transition:height 1s;
                border:2px dotted black;
            }
            [data-bind='']
            {
                border:2px solid black;
            }
        </style>
    </head>
    <body>

        <div>
            <button id="button1">branch</button>
            <div id="menu1" data-open="false" data-bind>
                <div>leaf!</div>
                <button id="button2">branch</button>
                <div id="menu2" data-open="false" data-bind>
                    <div>leaf!</div>
                </div>
            </div>
        </div>

        <script>
            function TransitionDetector(inElement, inAttribute, inHandlerStart, inHandlerStop)
            {
                var handleRun = function(inEvent)
                {
                    var t, keys;

                    t = inEvent.target;
                    keys = t.getAttribute(inAttribute);
                    if(keys === null){return;}

                    if(!keys || keys == "")
                    {
                        keys = {};
                        inHandlerStart(t);
                    }
                    else
                    {
                        keys = JSON.parse(keys);
                    }

                    if(keys[inEvent.propertyName]){return;}
                    keys[inEvent.propertyName] = true;
                    t.setAttribute(inAttribute, JSON.stringify(keys));
                };
                var handleEnd = function(inEvent)
                {
                    var t, keys;

                    t = inEvent.target;
                    keys = t.getAttribute(inAttribute);
                    if(keys === null){return;}

                    keys = JSON.parse(keys);
                    keys[inEvent.propertyName] = false;
                    for(var key in keys)
                    {
                        if(keys[key] == true)
                        {
                            t.setAttribute(inAttribute, JSON.stringify(keys));
                            return;
                        }
                    }
                    t.setAttribute(inAttribute, "");
                    inHandlerStop(t);
                };

                inElement.addEventListener("transitionrun", handleRun);
                inElement.addEventListener("transitionend", handleEnd);

                return function()
                {
                    inElement.removeEventListener("transitionrun", handleRun);
                    inElement.removeEventListener("transitionend", handleEnd);
                };
            }

            function Collapse(inElement, inMode)
            {
                inElement.style.height = inElement.clientHeight+"px";
                inElement.style.overflow = "hidden";
                setTimeout(function(){ inElement.style.height = (inMode ? inElement.scrollHeight : 0)+"px"; });
            }

            function Pair(inSelButton, inSelMenu, inAttribute)
            {
                var button, menu;
                button = document.querySelector(inSelButton)
                  menu = document.querySelector(inSelMenu);
                button.addEventListener("click", function()
                {
                    var status = menu.getAttribute(inAttribute)=="true";
                    menu.setAttribute(inAttribute, !status);
                    Collapse(menu, !status);
                });
            };
        </script>
        <script>
            Pair("#button1", "#menu1", "data-open");
            Pair("#button2", "#menu2", "data-open");

            TransitionDetector(document.body, "data-bind",
            e=>
            {
                if(e.getAttribute("data-open")=="true")
                {
                    // starting to open
                    e.querySelectorAll("[data-bind]").forEach(e=>e.style.transition = "");
                }
            },
            e=>
            {
                if(e.getAttribute("data-open")=="true")
                {
                    // done opening
                    e.style.transition = "";
                    e.style.overflow = "visible";
                    e.style.height = "auto";
                }
                else
                {
                    // done closing
                    e.querySelectorAll("[data-bind]").forEach(e=>
                    {
                        e.setAttribute("data-bind", "");
                        e.setAttribute("data-open", false);
                        e.style.transition = "none";
                        e.style.overflow = "hidden";
                        e.style.height = "0px";
                    });
                }
            }
            );
        </script>

    </body>
</html>