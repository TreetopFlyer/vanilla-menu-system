<!DOCTYPE html>
<html>
    <head>
        <style>
            .Branch__Menu
            {
                position:relative;
                display:block;
                padding:0;
                height:0;
                overflow:hidden;
                background:rgba(128, 128, 128, 0.5);
                border-radius:10px;
            }
            [data-open='false']
            {
                opacity:0;
                transition:height 1.0s, opacity 0.4s;
            }
            [data-open='true']
            {
                opacity:1;
                transition:height 0.4s, opacity 1.0s;
            }
        </style>

    </head>
    <body>

        <nav>
            <ul>
                <li><a href="#">Leaf</a></li>
                <li><a href="#">Leaf</a></li>
                <li class="Branch Branch--Root">
                    <span class="Branch__Button">Branch</span>
                    <span class="Branch__Menu" data-bind data-open="false">
                        <ul>
                            <li><a href="#">Leaf</a></li>
                            <li class="Branch">
                                <span class="Branch__Button">Branch</span>
                                <span class="Branch__Menu" data-bind data-open="false">
                                    <ul>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                    </ul>
                                </span>
                            </li>
                            <li><a href="#">Leaf</a></li>
                            <li><a href="#">Leaf</a></li>
                            <li class="Branch">
                                <span class="Branch__Button">Branch</span>
                                <span class="Branch__Menu" data-bind data-open="false">
                                    <ul>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                    </ul>
                                </span>
                            </li>
                        </ul>
                    </span>
                </li>
                <li><a href="#">Leaf</a></li>
            </ul>
        </nav>

<script>
function DetectTransition(inConfig)
{
    var inAttribute = inConfig.writeTo;
    var inHandlerStart = inConfig.onStart;
    var inHandlerStop = inConfig.onStop;
    var handleRun = function(inEvent)
    {
        var t, keys;

        t = inEvent.target;
        keys = t.getAttribute(inAttribute);
        if(keys === null){return;}

        if(!keys || keys == "")
        {
            keys = {};
            inHandlerStart(t, inEvent);
        }
        else
        {
            keys = JSON.parse(keys);
        }

        if(keys[inEvent.propertyName]){return;}
        keys[inEvent.propertyName] = true;
        t.setAttribute(inAttribute, JSON.stringify(keys));
    };
    var handleEnd = function(inEvent)
    {
        var t, keys;

        t = inEvent.target;
        keys = t.getAttribute(inAttribute);
        if(keys === null){return;}

        keys = JSON.parse(keys);
        keys[inEvent.propertyName] = false;
        for(var key in keys)
        {
            if(keys[key] == true)
            {
                t.setAttribute(inAttribute, JSON.stringify(keys));
                return;
            }
        }
        t.setAttribute(inAttribute, "");
        inHandlerStop(t, inEvent);
    };

    document.addEventListener("transitionrun", handleRun);
    document.addEventListener("transitionend", handleEnd);

    return function()
    {
        document.removeEventListener("transitionrun", handleRun);
        document.removeEventListener("transitionend", handleEnd);
    };
}
function DetectClick(inConfig)
{
    function handleClick(e)
    {
        document.querySelectorAll(inConfig.selector).forEach(function(root)
        {
            (root.contains(e.target) ? inConfig.onIn : inConfig.onOut )(root, e);
        });
    }
    document.addEventListener("click", handleClick);
    return function(){document.removeEventListener("click", handleClick);}
}
</script>
<script>
var AttributeOpen = "data-open";
var AttributeLive = "data-bind";
function SetStyle(inElement, inHeight, inTransition)
{
    if(inTransition != null){ inElement.style.transition = inTransition; }
    inElement.style.height = inHeight;
}
function SetState(inElement, inOpen, inTransition)
{
    if(inTransition != null){ inElement.setAttribute(AttributeLive, inTransition); }
    inElement.setAttribute(AttributeOpen, inOpen);
}
function GetState(inElement, inTransition)
{
    if(inTransition != null){ return (inElement.getAttribute(AttributeLive) != ""); }
    return inElement.getAttribute(AttributeOpen)=="true";
}
DetectTransition({
    writeTo: AttributeLive,
    onStart: (inMenu, inEvent)=>
    {
        var open, i, step;
        open = GetState(inMenu);
        if(open)
        {
            inMenu.querySelectorAll(".Branch__Menu").forEach(function(inElement){ SetStyle(inElement, "0px", ""); });
        }
        for(i=0; i<inEvent.path.length-3; i++)
        {
            step = inEvent.path[i];
            if(GetState(step, true))
            {
                height = open ? parseInt(inMenu.style.height) : -inMenu.scrollHeight;
                SetStyle(step, (parseInt(step.style.height)+height)+"px");
            }
        }
    },
    onStop: (inMenu, inEvent)=>
    {
        if(GetState(inMenu))
        {
            SetStyle(inMenu, "auto");
        }
        else
        {
            inMenu.querySelectorAll(".Branch__Menu").forEach(e=>
            {
                SetState(e, false, "");
                SetStyle(e, "0px", "none");
            })
        }
    }
});
DetectClick({
    selector:".Branch--Root",
    onIn:function(inBranch, inEvent)
    {
        if(inEvent.target.classList.contains("Branch__Button"))
        {
            var menu = inEvent.target.nextElementSibling;
            var status = GetState(menu);
            SetState(menu, !status);
            SetStyle(menu, menu.clientHeight+"px");
            setTimeout(function(){ SetStyle(menu, (status?0:menu.scrollHeight)+"px"); });
        }
    },
    onOut:function(inBranch, inEvent)
    {
        var menu = inBranch.querySelector(".Branch__Menu");
        if(GetState(menu))
        {
            SetState(menu, false);
            SetStyle(menu, menu.clientHeight+"px");
            setTimeout(function(){ SetStyle(menu, "0px"); });
        }
    }
});
</script>

    </body>
</html>