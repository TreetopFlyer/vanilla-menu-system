<!DOCTYPE html>
<html>
    <head>
        <style>
            [data-open]
            {
                position:relative;
                display:block;
                width:300px;
                height:300px;
                background:red;
                padding:10px;
                transition:width 1s, height 2s;
            }
            [data-open='true']
            {
                width:600px;
                height:100px;
            }
            [data-bind='']
            {
                border:2px solid black;
            }
        </style>
    </head>
    <body>

        <div>
            <button id="button1">branch</button>
            <div id="menu1" data-open="false" data-bind>
                <div>leaf!</div>
                <button id="button2">branch</button>
                <div id="menu2" data-open="false" data-bind>
                    <div>leaf!</div>
                </div>
            </div>
        </div>

        <script>
            function TransitionDetector(inElement, inAttribute, inHandlerStart, inHandlerStop)
            {
                var handleRun = function(inEvent)
                {
                    var t;
                    var keys;

                    t = inEvent.target;
                    keys = t.getAttribute(inAttribute);
                    if(keys === null){return;}

                    if(keys == "")
                    {
                        keys = {};
                        inHandlerStart(t);
                    }
                    else
                    {
                        keys = JSON.parse(keys);
                    }

                    if(keys[inEvent.propertyName]){return;}
                    keys[inEvent.propertyName] = true;
                    t.setAttribute(inAttribute, JSON.stringify(keys));
                };
                var handleEnd = function(inEvent)
                {
                    var t;
                    var keys;

                    t = inEvent.target;
                    keys = t.getAttribute(inAttribute);
                    if(keys === null){return;}

                    keys = JSON.parse(keys);
                    keys[inEvent.propertyName] = false;
                    for(var key in keys)
                    {
                        if(keys[key] == true)
                        {
                            t.setAttribute(inAttribute, JSON.stringify(keys));
                            return;
                        }
                    }
                    t.setAttribute(inAttribute, "");
                    inHandlerStop(t);
                };

                inElement.addEventListener("transitionrun", handleRun);
                inElement.addEventListener("transitionend", handleEnd);

                return function()
                {
                    inElement.removeEventListener("transitionrun", handleRun);
                    inElement.removeEventListener("transitionend", handleEnd);
                };
            }
        </script>
        <script>

            var pair = function(inSelButton, inSelMenu, inAttribute)
            {
                document.querySelector(inSelButton).addEventListener("click", function()
                {
                    var element, value;
                    element = document.querySelector(inSelMenu);
                    value = element.getAttribute(inAttribute)=="true";
                    element.setAttribute( inAttribute, !value );
                });
            };

            pair("#button1", "#menu1", "data-open");
            pair("#button2", "#menu2", "data-open");

            TransitionDetector(document.body, "data-bind",
            e=>
            {
                if(e.getAttribute("data-open")=="false"){return;}
                e.querySelectorAll("[data-bind]").forEach(e=>
                {
                    e.style.transition = "";
                });
            },
            e=>
            {
                if(e.getAttribute("data-open")=="true"){return;}
                e.querySelectorAll("[data-bind]").forEach(e=>
                {
                    e.style.transition = "none";
                    e.setAttribute("data-open", false);
                    e.setAttribute("data-bind", "");
                });
            }
            );
            
        </script>

    </body>
</html>