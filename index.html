<!DOCTYPE html>
<html>
    <head>
        <style>
            .Branch__Menu
            {
                position:relative;
                display:block;
                height:0;
                opacity:0;
                padding:0;
                overflow:hidden;
                background:rgba(128, 128, 128, 0.5);
                border-radius:10px;
                transition:height 1s, opacity 0.6s;
            }
            [data-open='true']
            {
                opacity:1;
            }
        </style>

    </head>
    <body>

        <nav>
            <ul>
                <li><a href="#">Leaf</a></li>
                <li><a href="#">Leaf</a></li>
                <li class="Branch Branch--Root">
                    <span class="Branch__Button">Branch</span>
                    <span class="Branch__Menu" data-bind data-open="false">
                        <ul>
                            <li><a href="#">Leaf</a></li>
                            <li class="Branch">
                                <span class="Branch__Button">Branch</span>
                                <span class="Branch__Menu" data-bind data-open="false">
                                    <ul>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                    </ul>
                                </span>
                            </li>
                            <li><a href="#">Leaf</a></li>
                            <li><a href="#">Leaf</a></li>
                            <li class="Branch">
                                <span class="Branch__Button">Branch</span>
                                <span class="Branch__Menu" data-bind data-open="false">
                                    <ul>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                        <li><a href="#">Leaf</a></li>
                                    </ul>
                                </span>
                            </li>
                        </ul>
                    </span>
                </li>
                <li><a href="#">Leaf</a></li>
            </ul>
        </nav>

        <script>
            function TransitionDetector(inAttribute, inHandlerStart, inHandlerStop)
            {
                var handleRun = function(inEvent)
                {
                    var t, keys;

                    t = inEvent.target;
                    keys = t.getAttribute(inAttribute);
                    if(keys === null){return;}

                    if(!keys || keys == "")
                    {
                        keys = {};
                        inHandlerStart(t, inEvent);
                    }
                    else
                    {
                        keys = JSON.parse(keys);
                    }

                    if(keys[inEvent.propertyName]){return;}
                    keys[inEvent.propertyName] = true;
                    t.setAttribute(inAttribute, JSON.stringify(keys));
                };
                var handleEnd = function(inEvent)
                {
                    var t, keys;

                    t = inEvent.target;
                    keys = t.getAttribute(inAttribute);
                    if(keys === null){return;}

                    keys = JSON.parse(keys);
                    keys[inEvent.propertyName] = false;
                    for(var key in keys)
                    {
                        if(keys[key] == true)
                        {
                            t.setAttribute(inAttribute, JSON.stringify(keys));
                            return;
                        }
                    }
                    t.setAttribute(inAttribute, "");
                    inHandlerStop(t, inEvent);
                };

                document.addEventListener("transitionrun", handleRun);
                document.addEventListener("transitionend", handleEnd);

                return function()
                {
                    document.removeEventListener("transitionrun", handleRun);
                    document.removeEventListener("transitionend", handleEnd);
                };
            }

            function ClickDetector(inSelectorRoot, inSelectorBranch, inSelectorButton, inSelectorMenu, inHandlerClose, inHandlerToggle)
            {
                function handleClick(e)
                {
                    document.querySelectorAll(inSelectorRoot).forEach(root=>
                    {
                        if(!root.contains(e.target))
                        {
                            inHandlerClose(root, root.querySelector(inSelectorButton), root.querySelector(inSelectorMenu), e.target);
                        }
                    });
                    document.querySelectorAll(inSelectorBranch).forEach(branch=>
                    {
                        if(e.target == branch.querySelector(inSelectorButton))
                        {
                            inHandlerToggle(branch, branch.querySelector(inSelectorButton), branch.querySelector(inSelectorMenu), e.target);
                        }
                    });
                }

                document.addEventListener("click", handleClick);
                return function(){document.removeEventListener("click", handleClick);}
            }
        
        </script>
        <script>
            
            function Collapse(inElement, inMode)
            {
                inElement.style.height = inElement.clientHeight+"px";
                inElement.style.overflow = "hidden";
                setTimeout(function(){ inElement.style.height = (inMode ? inElement.scrollHeight : 0)+"px"; });
            }

            TransitionDetector("data-bind",
            (inMenu, inEvent)=>
            {
                var opening;
                var i, step, check;

                opening = inMenu.getAttribute("data-open")=="true";

                // interrupt parents
                for(i=0; i<inEvent.path.length-3; i++)
                {
                    step = inEvent.path[i];
                    check = step.getAttribute("data-bind");
                    if(check && check !== "")
                    {
                        height = opening ? parseInt(inMenu.style.height) : -inMenu.scrollHeight;
                        console.log("adjusting parent by", height);
                        step.style.height = (parseInt(step.style.height) + height )+"px";
                    }
                }

                // remove instant transitions on children
                if(opening)
                {
                    inMenu.querySelectorAll("[data-bind]").forEach(e=>e.style.transition = "");
                }
            },
            (inMenu, inEvent)=>
            {
                if(inMenu.getAttribute("data-open")=="true")
                {
                    // done opening
                    inMenu.style.transition = "";
                    inMenu.style.overflow = "visible";
                    inMenu.style.height = "auto";
                }
                else
                {
                    // done closing
                    inMenu.querySelectorAll("[data-bind]").forEach(e=>
                    {
                        e.setAttribute("data-bind", "");
                        e.setAttribute("data-open", false);
                        e.style.transition = "none";
                        e.style.overflow = "hidden";
                        e.style.height = "0px";
                    })
                }
            }
            );
        
            ClickDetector(".Branch--Root", ".Branch", ".Branch__Button", ".Branch__Menu",
            (inBranch, inButton, inMenu, inEvent)=>
            {
                // close (click away)
                if(inMenu.getAttribute("data-open") == "true")
                {
                    inMenu.setAttribute("data-open", false);
                    Collapse(inMenu, false);
                }
            }
            ,
            (inBranch, inButton, inMenu, inEvent)=>
            {
                // toggle
                var status = inMenu.getAttribute("data-open")=="true";
                inMenu.setAttribute("data-open", !status);
                Collapse(inMenu, !status);
            }
            );

        </script>

    </body>
</html>